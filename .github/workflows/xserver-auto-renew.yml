name: XServer GAME Auto Renew

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 21:10 è¿è¡Œ (UTC 13:10)
    - cron: '10 13 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  auto-login:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      actions: write

    timeout-minutes: 15

    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/Xserver-Auto-Renew
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: scripts

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        # æ˜¾å¼åˆ‡æ¢åˆ° scripts ç›®å½•è¿›è¡Œå®‰è£…
        run: |
          python -m pip install --upgrade pip
          if [ -f "scripts/requirements.txt" ]; then
            pip install -r scripts/requirements.txt
          fi

      - name: ğŸ­ å®‰è£… Playwright æµè§ˆå™¨
        run: playwright install chromium

      - name: ğŸŒ å®‰è£…æ—¥æ–‡å­—ä½“æ”¯æŒ
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra

      - name: ğŸš€ è¿è¡Œ XServer å®Œå…¨è‡ªåŠ¨åŒ–ç™»å½•
        env:
          XSERVER_EMAIL: ${{ secrets.XSERVER_EMAIL }}
          XSERVER_PASSWORD: ${{ secrets.XSERVER_PASSWORD }}
          CLOUD_MAIL: ${{ secrets.CLOUD_MAIL }}
        run: |
          echo "ğŸš€ å¯åŠ¨è‡ªåŠ¨åŒ–æµç¨‹..."
          # è¿›å…¥è„šæœ¬æ‰€åœ¨ç›®å½•
          cd scripts
          python main.py
          # è¿è¡Œå®Œåå¦‚æœç”Ÿæˆäº† README.md æˆ–å›¾ç‰‡ï¼Œå°†å…¶ç§»åŠ¨åˆ°æ ¹ç›®å½•ä»¥ä¾¿åç»­æ­¥éª¤å¤„ç†
          mv README.md .. || true
          mv *.png .. || true

      - name: ğŸ“ æäº¤README.mdåˆ°ä»“åº“
        if: always()
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add README.md
          git diff --staged --quiet || git commit -m "ğŸ“Š è‡ªåŠ¨æ›´æ–°ç»­æœŸçŠ¶æ€æŠ¥å‘Š [$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')]"
          git push

      - name: ğŸ“± å‘é€Telegramé€šçŸ¥
        # ä¿®æ­£ç‚¹ï¼šä½¿ç”¨ env ä¸Šä¸‹æ–‡è¿›è¡Œåˆ¤æ–­
        if: always() && env.TELEGRAM_BOT_TOKEN != '' && env.TELEGRAM_CHAT_ID != ''
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -f "README.md" ]; then
            RENEWAL_STATUS=$(grep "ğŸ“Šç»­æœŸç»“æœï¼š" README.md | sed 's/.*ğŸ“Šç»­æœŸç»“æœï¼š\([^<]*\).*/\1/' | sed 's/<br>//')
            OLD_DATE=$(grep "ğŸ•›ï¸æ—§åˆ°æœŸæ—¶é—´:" README.md | sed 's/.*ğŸ•›ï¸æ—§åˆ°æœŸæ—¶é—´: `\([^`]*\)`.*/\1/')
            NEW_DATE=$(grep "ğŸ•¡ï¸æ–°åˆ°æœŸæ—¶é—´:" README.md | sed 's/.*ğŸ•¡ï¸æ–°åˆ°æœŸæ—¶é—´: `\([^`]*\)`.*/\1/' || echo "")
          else
            RENEWAL_STATUS="â“Unknown"
            OLD_DATE="N/A"
            NEW_DATE=""
          fi

          # ä½¿ç”¨ printf å¤„ç†æ¢è¡Œï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å¯¼è‡´ shell è„šæœ¬æŠ¥é”™
          MESSAGE=$(printf "ğŸ¢Xserverç»­æœŸé€šçŸ¥\nğŸ“…æ‰§è¡Œæ—¶é—´ï¼š$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')\n\nğŸ–¥ï¸æœåŠ¡å™¨ï¼šğŸ‡¯ğŸ‡µXserver(Mc)\nğŸ“Šç»­æœŸç»“æœï¼š${RENEWAL_STATUS}\nğŸ•›ï¸æ—§åˆ°æœŸæ—¶é—´ï¼š${OLD_DATE}")

          if [ ! -z "$NEW_DATE" ]; then
            MESSAGE="${MESSAGE}$(printf "\nğŸ•¡ï¸æ–°åˆ°æœŸæ—¶é—´ï¼š${NEW_DATE}")"
          fi

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TELEGRAM_CHAT_ID}" \
            --data-urlencode "text=${MESSAGE}" \
            -d "parse_mode=Markdown"

      - name: ğŸ“¸ ä¸Šä¼ è¿è¡Œç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xserver-auto-login-results-${{ github.run_number }}
          path: "*.png"
          retention-days: 1

      - name: ğŸ§¹ æ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œè®°å½•
        uses: MajorScruffy/delete-old-workflow-runs@v0.3.0
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          repository: ${{ github.repository }}
          older-than-seconds: 3600
